<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–í–≥–∞–¥–∞–π —Ñ—ñ–ª—å–º ‚Äî Projector Prototype 2</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#121a27cc;
      --tileBg: rgba(8, 12, 24, 0.95); /* –º–∞–π–∂–µ –Ω–µ–ø—Ä–æ–∑–æ—Ä–∞ –ø–ª–∏—Ç–∫–∞ */
      --tileHover: rgba(20, 28, 55, 0.98);
      --text:#e8eefc;
      --muted:#a9b5d3;
      --primary:#152248;
      --primaryBorder:#3d5bd6;
      --danger:#2a1414;
      --dangerBorder:#6b2a2a;
      --border:#253150;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    .app{ height:100%; display:grid; grid-template-rows:auto 1fr; }

    .topbar{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:10px 12px; background:var(--panel); backdrop-filter: blur(8px);
      border-bottom:1px solid #27324a;
    }
    .left, .right{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .meta{ display:flex; flex-direction:column; line-height:1.1; }
    .meta .title{ font-weight:900; letter-spacing:.2px; }
    .meta .sub{ color:var(--muted); font-size:12px; }

    .btn{
      appearance:none; border:1px solid #2a3754; background:#121a27;
      color:var(--text); padding:10px 12px; border-radius:12px; cursor:pointer;
      font-weight:800; letter-spacing:.2px;
      transition:transform .05s ease, background .15s ease, border-color .15s ease;
      user-select:none;
      text-decoration:none; /* —â–æ–± <a> –≤–∏–≥–ª—è–¥–∞–≤ —è–∫ –∫–Ω–æ–ø–∫–∞ */
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{ background:#18233a; border-color:#3a4c74; }
    .btn:active{ transform:scale(0.98); }
    .btn.primary{ border-color:var(--primaryBorder); background:var(--primary); }
    .btn.danger{ border-color:var(--dangerBorder); background:var(--danger); color:#ffd5d5; }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }
    .btn.ghost{ background:transparent; border-color:#2a3754; }
    .btn.ghost:hover{ background:#18233a; }

    .kbd{ font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; padding:2px 6px; border:1px solid #2a3754; border-radius:8px; color:var(--muted); }

    .stage{ position:relative; display:grid; place-items:center; overflow:hidden; }
    .frame{
      position:relative;
      width:min(96vw, 96vh*1.65);
      height:min(86vh, 96vw/1.65);
      border-radius:18px;
      overflow:hidden;
      box-shadow:0 20px 60px rgba(0,0,0,.45);
      border:1px solid var(--border);
      background:#0a0f1b;
    }

    /* –î–≤–∞ —à–∞—Ä–∏: —á—ñ—Ç–∫–∏–π + blur */
    .image{
      position:absolute; inset:0;
      background-position:center;
      background-size:cover;
    }
    .imageSharp{ filter:none; }
    .imageBlur{
      filter: blur(20px) brightness(0.50) saturate(0.90) contrast(1.02);
      transform: scale(1.10); /* —Ö–æ–≤–∞—î –∫—Ä–∞—ó –ø—ñ—Å–ª—è blur */
      -webkit-mask: url(#tilesMask);
      mask: url(#tilesMask);
    }
    .maskSvg{
      position:absolute;
      width:0; height:0;
      pointer-events:none;
    }

    /* –°—ñ—Ç–∫–∞ –ø–ª–∏—Ç–æ–∫ */
    .grid{
      position:absolute; inset:0;
      display:grid;
      gap:6px;
      padding:10px;
      pointer-events:auto;
    }
    .tile{
      display:grid; place-items:center;
      background:var(--tileBg);
      border:1px solid #2a3754;
      border-radius:14px;
      font-size:clamp(18px, 2.2vw, 34px);
      font-weight:900;
      color:#ffffff;
      text-shadow:0 2px 10px rgba(0,0,0,.6);
      cursor:pointer;
      user-select:none;
      transition: background .15s ease, transform .08s ease, opacity .25s ease;
    }
    .tile:hover{ background:var(--tileHover); }
    .tile:active{ transform:scale(0.98); }
    .tile.opened{
      opacity:0;
      pointer-events:none;
    }

    /* –í—ñ–¥–ø–æ–≤—ñ–¥—å */
    .answerOverlay{
      position:absolute; inset:0;
      display:none;
      align-items:flex-end;
      background:linear-gradient(180deg, rgba(0,0,0,0) 35%, rgba(0,0,0,.78) 100%);
      padding:18px;
      pointer-events:none; /* —â–æ–± –Ω–µ –±–ª–æ–∫—É–≤–∞–ª–æ –∫–ª—ñ–∫–∏, –∫—Ä—ñ–º –∫–Ω–æ–ø–∫–∏ */
    }
    .answerOverlay.show{ display:flex; }
    .answerBox{
      width:100%;
      background:rgba(15,23,42,.78);
      border:1px solid #2a3754;
      border-radius:16px;
      padding:14px 16px;
      backdrop-filter: blur(8px);
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      pointer-events:auto;
    }
    .answerText{
      font-size:clamp(18px, 2.5vw, 40px);
      font-weight:950;
      letter-spacing:.3px;
    }
    .hint{
      color:var(--muted);
      font-size:12px;
      margin-top:6px;
    }

    @media (max-width: 720px){
      .btn{ padding:9px 10px; border-radius:12px; }
      .grid{ gap:5px; padding:8px; }
      .tile{ border-radius:12px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="left">
        <!-- ‚úÖ –ö–ù–û–ü–ö–ê –ù–ê–ó–ê–î –î–û –ú–ï–ù–Æ -->
        <a class="btn ghost" href="../../" title="–ù–∞–∑–∞–¥ –¥–æ –º–µ–Ω—é">‚Üê –ú–µ–Ω—é</a>

        <div class="meta">
          <div class="title">üé¨ –í–≥–∞–¥–∞–π —Ñ—ñ–ª—å–º / –º—É–ª—å—Ç—Ñ—ñ–ª—å–º</div>
          <div class="sub">
            –ö–ª—ñ–∫ –ø–æ —Ü–∏—Ñ—Ä—ñ –≤—ñ–¥–∫—Ä–∏–≤–∞—î —Ñ—Ä–∞–≥–º–µ–Ω—Ç ¬∑
            <span id="openedInfo">–í—ñ–¥–∫—Ä–∏—Ç–æ: 0/24</span>
            ¬∑ <span id="packInfo">–ü–∞–∫: demo</span>
          </div>
        </div>
      </div>

      <div class="right">
        <button class="btn" id="btnUndo" title="Undo (U)">Undo <span class="kbd">U</span></button>
        <button class="btn" id="btnReset" title="Reset (R)">Reset <span class="kbd">R</span></button>
        <button class="btn" id="btnReveal" title="Reveal all">Reveal</button>
        <button class="btn primary" id="btnAnswer" title="–ü–æ–∫–∞–∑–∞—Ç–∏/—Å—Ö–æ–≤–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å (A)">Answer <span class="kbd">A</span></button>
        <button class="btn danger" id="btnNext" title="Next (N)">Next <span class="kbd">N</span></button>
      </div>
    </div>

    <div class="stage">
      <div class="frame" id="frame">

        <!-- 1) –ß–Ü–¢–ö–ò–ô –§–û–ù -->
        <div class="image imageSharp" id="imageSharp"></div>

        <!-- 2) –ó–ê–ë–õ–Æ–†–ï–ù–ò–ô –§–û–ù (–±—É–¥–µ ‚Äú–≤–∏—Ä—ñ–∑–∞—Ç–∏—Å—è‚Äù –º–∞—Å–∫–æ—é) -->
        <div class="image imageBlur" id="imageBlur"></div>

        <!-- SVG –º–∞—Å–∫–∞: –±—ñ–ª–µ = blur –≤–∏–¥–Ω–æ, —á–æ—Ä–Ω–µ = ‚Äú–¥—ñ—Ä–∫–∞‚Äù (–≤–∏–¥–Ω–æ sharp) -->
        <svg class="maskSvg" viewBox="0 0 1 1" preserveAspectRatio="none" aria-hidden="true">
          <defs>
            <mask id="tilesMask" maskContentUnits="objectBoundingBox">
              <rect x="0" y="0" width="1" height="1" fill="white"></rect>
              <g id="maskHoles"></g>
            </mask>
          </defs>
        </svg>

        <!-- –°—ñ—Ç–∫–∞ –ø–ª–∏—Ç–æ–∫ -->
        <div class="grid" id="grid" aria-label="tiles"></div>

        <!-- –í—ñ–¥–ø–æ–≤—ñ–¥—å -->
        <div class="answerOverlay" id="answerOverlay">
          <div class="answerBox">
            <div>
              <div class="answerText" id="answerText">–í—ñ–¥–ø–æ–≤—ñ–¥—å</div>
              <div class="hint">–ü–æ—Ä–∞–¥–∞: –ø–æ–∫–∞–∑—É–π—Ç–µ –≤—ñ–¥–ø–æ–≤—ñ–¥—å —Ç—ñ–ª—å–∫–∏ –ø—ñ—Å–ª—è —Å–ø—Ä–æ–±–∏ üôÇ</div>
            </div>
            <button class="btn" id="btnHideAnswer">–°—Ö–æ–≤–∞—Ç–∏</button>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
(() => {
  // ====== CONFIG ======
  const DEFAULT_ROWS = 4;
  const DEFAULT_COLS = 6;
  const PACK_URL = "assets/pack.json"; // –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ –∫–∞–¥—Ä—ñ–≤
  const TILE_GAP_PX = 6;

  // Demo pack (fallback) ‚Äî –ø—Ä–∞—Ü—é—î –Ω–∞–≤—ñ—Ç—å –±–µ–∑ assets/pack.json —Ç–∞ –∫–∞—Ä—Ç–∏–Ω–æ–∫
  const demoPack = [
    { id: "001", answer: "DEMO: –®—Ä–µ–∫", image: null, bg: "linear-gradient(135deg,#1f7a3a,#0b2a4a)" },
    { id: "002", answer: "DEMO: –ö—Ä–∏–∂–∞–Ω–µ —Å–µ—Ä—Ü–µ", image: null, bg: "linear-gradient(135deg,#4aa3ff,#1a1f4a)" },
    { id: "003", answer: "DEMO: –ö–æ—Ä–æ–ª—å –õ–µ–≤", image: null, bg: "linear-gradient(135deg,#ffb703,#6a040f)" }
  ];

  // ====== STATE ======
  let rows = DEFAULT_ROWS;
  let cols = DEFAULT_COLS;
  let tiles = [];         // DOM tiles
  let openedStack = [];   // indexes opened (for undo)
  let currentIndex = 0;
  let packName = "demo";
  let pack = demoPack;

  // ====== DOM ======
  const gridEl = document.getElementById("grid");
  const openedInfoEl = document.getElementById("openedInfo");
  const packInfoEl = document.getElementById("packInfo");

  const imageSharpEl = document.getElementById("imageSharp");
  const imageBlurEl  = document.getElementById("imageBlur");
  const maskHolesEl  = document.getElementById("maskHoles");

  const btnUndo = document.getElementById("btnUndo");
  const btnReset = document.getElementById("btnReset");
  const btnReveal = document.getElementById("btnReveal");
  const btnAnswer = document.getElementById("btnAnswer");
  const btnNext = document.getElementById("btnNext");

  const answerOverlay = document.getElementById("answerOverlay");
  const answerText = document.getElementById("answerText");
  const btnHideAnswer = document.getElementById("btnHideAnswer");

  // ====== UI helpers ======
  function updateMeta(){
    const opened = openedStack.length;
    openedInfoEl.textContent = `–í—ñ–¥–∫—Ä–∏—Ç–æ: ${opened}/${rows*cols}`;
    packInfoEl.textContent = `–ü–∞–∫: ${packName}`;
    btnUndo.disabled = openedStack.length === 0;
  }

  function hideAnswer(){
    answerOverlay.classList.remove("show");
  }
  function toggleAnswer(){
    if(answerOverlay.classList.contains("show")) hideAnswer();
    else answerOverlay.classList.add("show");
  }

  // ====== Mask logic (–¥—ñ—Ä–∫–∏ –≤ blur-—à–∞—Ä—ñ) ======
  function clearMaskHoles(){
    maskHolesEl.innerHTML = "";
  }

  function tileRectObjectBBox(i){
    const r = Math.floor(i / cols);
    const c = i % cols;
    const w = 1 / cols;
    const h = 1 / rows;
    return { x: c * w, y: r * h, w, h };
  }

  function addMaskHole(i){
    const {x,y,w,h} = tileRectObjectBBox(i);
    const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
    rect.setAttribute("x", x);
    rect.setAttribute("y", y);
    rect.setAttribute("width", w);
    rect.setAttribute("height", h);
    rect.setAttribute("fill", "black"); // —á–æ—Ä–Ω–µ = –ø—Ä–æ–∑–æ—Ä–æ –≤ blur (–≤–∏–¥–Ω–æ sharp)
    rect.dataset.index = String(i);
    maskHolesEl.appendChild(rect);
  }

  function removeMaskHole(i){
    const el = maskHolesEl.querySelector(`rect[data-index="${i}"]`);
    if(el) el.remove();
  }

  // ====== Background ======
  function setBackgroundForItem(item){
    const bg = item.image
      ? `url("${item.image}")`
      : (item.bg || "linear-gradient(135deg,#111827,#0b1020)");

    imageSharpEl.style.backgroundImage = bg;
    imageBlurEl.style.backgroundImage  = bg;

    answerText.textContent = item.answer || "‚Äî";
  }

  // ====== Grid ======
  function buildGrid(){
    gridEl.innerHTML = "";
    tiles = [];
    openedStack = [];
    clearMaskHoles();
    hideAnswer();

    gridEl.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
    gridEl.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
    gridEl.style.gap = `${TILE_GAP_PX}px`;

    const total = rows * cols;
    for(let i=0;i<total;i++){
      const t = document.createElement("div");
      t.className = "tile";
      t.textContent = (i+1).toString();
      t.dataset.index = i.toString();
      t.addEventListener("click", () => openTile(i));
      tiles.push(t);
      gridEl.appendChild(t);
    }
    updateMeta();
  }

  function openTile(i){
    const t = tiles[i];
    if(!t || t.classList.contains("opened")) return;

    t.classList.add("opened");
    openedStack.push(i);

    // –≤–∏—Ä—ñ–∑–∞—î–º–æ ‚Äú–¥—ñ—Ä–∫—É‚Äù –≤ blur, —â–æ–± –ø–æ–∫–∞–∑–∞—Ç–∏ sharp
    addMaskHole(i);

    updateMeta();
  }

  function undo(){
    const i = openedStack.pop();
    if(i === undefined) return;

    tiles[i].classList.remove("opened");
    removeMaskHole(i);

    updateMeta();
  }

  function resetAll(){
    openedStack = [];
    tiles.forEach(t => t.classList.remove("opened"));
    clearMaskHoles();
    hideAnswer();
    updateMeta();
  }

  function revealAll(){
    openedStack = [];
    clearMaskHoles();

    tiles.forEach((t, idx) => {
      t.classList.add("opened");
      openedStack.push(idx);
      addMaskHole(idx);
    });

    updateMeta();
  }

  function nextItem(){
    currentIndex = (currentIndex + 1) % pack.length;
    loadCurrent();
  }

  function loadCurrent(){
    const item = pack[currentIndex] || { answer:"‚Äî", image:null };

    // —è–∫—â–æ image –∑–∞–¥–∞–Ω–æ —è–∫ "001.jpg" ‚Äî –¥–æ–ø–∏—à–µ–º–æ "assets/"
    if(item.image && !item.image.includes("://") && !item.image.startsWith("/") && !item.image.startsWith("assets/")){
      item.image = "assets/" + item.image;
    }

    setBackgroundForItem(item);
    buildGrid();
    updateMeta();
  }

  // ====== Load pack.json ======
  async function loadPack(){
    try{
      const res = await fetch(PACK_URL, { cache: "no-store" });
      if(!res.ok) throw new Error("pack.json not found");
      const data = await res.json();
      if(!Array.isArray(data) || data.length === 0) throw new Error("pack.json empty");

      pack = data.map(x => ({
        id: String(x.id ?? ""),
        answer: String(x.answer ?? ""),
        image: x.image ? String(x.image) : null
      }));

      packName = "assets/pack.json";
    } catch (e){
      pack = demoPack;
      packName = "demo (fallback)";
    }
  }

  // ====== Events ======
  btnUndo.addEventListener("click", undo);
  btnReset.addEventListener("click", resetAll);
  btnReveal.addEventListener("click", revealAll);
  btnAnswer.addEventListener("click", toggleAnswer);
  btnHideAnswer.addEventListener("click", hideAnswer);
  btnNext.addEventListener("click", nextItem);

  window.addEventListener("keydown", (ev) => {
    const k = ev.key.toLowerCase();
    if(k === "u") undo();
    if(k === "r") resetAll();
    if(k === "a") toggleAnswer();
    if(k === "n") nextItem();
  });

  // ====== Start ======
  (async function init(){
    await loadPack();
    currentIndex = 0;
    loadCurrent();
  })();
})();
</script>
</body>
</html>
